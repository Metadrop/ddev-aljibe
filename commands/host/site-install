#!/bin/bash
#ddev-generated
## Description: Install given drupal site. A db file and files archive can be passed as additional parameters
## Usage: site-install [site] [db file] [files archive]
## Example: ddev site-install default
## Example:\n- Install site from configuration:\n\n    ddev site-install\n\n- Install site from database file\n\n    ddev site-install default db_dump.sql\n\n- Install site from database and files archive (tar.gz or zip)\n\n    ddev site-install default db_dump.sql files.tar.gz\n\n- Install site from configuration with files archive\n\n    ddev site-install default '' files.zip\n\n- Install site 'secondary' from configuration:\n\n    ddev site-install secondary\n\nNOTE: Although [flags] is displayed at the end of the command in the `Usage` section, meaning DDEV flags, please set options between `ddev` and `site-install`. If added to the end of the command, they will be passed to site install script and will cause errors.

# Run a drush command using ddev.
ddev_drush() {
  ddev drush @${SITE_ALIAS} "$@"
}

# Include the ddev_checks script
source "$(dirname "$0")/includes/aljibe_includes"

## Project must be running to run this command
star_project

SITE_PROFILES_FILE=".ddev/site-profiles"
SITE=${1:-'self'}

DB_FILE=${2:-''}
FILES_ARCHIVE=${3:-''}

if [ -z "$DB_FILE" ]; then
  INSTALL_MODE="config"
  echo "Installing site from configuration"
else
  INSTALL_MODE="db"
  echo "Installing from database file: $DB_FILE"
fi

if [ "$INSTALL_MODE" == "db" ]; then
  if [ ! -f "$DB_FILE" ]; then
    echo "Error: database file '$DB_FILE' not found."
    exit 1
  fi
fi

if [ -n "$FILES_ARCHIVE" ]; then
  if [ ! -f "$FILES_ARCHIVE" ]; then
    echo "Error: files archive '$FILES_ARCHIVE' not found."
    exit 1
  fi
  echo "Files archive provided: $FILES_ARCHIVE"
fi


ENV='local'
if [[ "$SITE" == *.* || "$SITE" == "self" ]]; then
  SITE_ALIAS=$SITE
else
  SITE_ALIAS=$SITE.$ENV
fi



DRUPAL_PROFILE=""
if [ -f $SITE_PROFILES_FILE ]; then
  source  $SITE_PROFILES_FILE
else
  echo "No SITE_PROFILES_FILE found. If your site needs a custom profile, please edit $SITE_PROFILES_FILE file."
fi

cd  $DDEV_APPROOT || exit 1

## Check if drush alias for this site exists when drush @${SITE_ALIAS} return "could not be found"
if [ "$(ddev_drush status 2>&1 | grep 'could not be found')" ]; then
  echo "Error: Drush alias for '${SITE}' does not exist. Please create it first so that the site can be installed."
  exit 1
fi


is_remote_alias=$(ddev drush sa --fields=host @${SITE_ALIAS} | /usr/bin/grep "host:" | wc -l)
if [ $is_remote_alias -eq 1 ]; then
  echo "Error: the provided drush alias '@${SITE_ALIAS}' seems a remote alias and this command only works with local environments."
fi

echo "Using '${SITE_ALIAS}' drush alias."
SITE_PATH=$(ddev_drush status --field=site)



chmod u+w ${DDEV_DOCROOT}/${SITE_PATH} -R
mkdir -p ${DDEV_DOCROOT}/${SITE_PATH}/files/behat/errors

# Ensure that the settings.ddev.php file exists and is properly configured
DBNAME=$(get_database_name "${SITE_ALIAS}")
echo "Using database: ${DBNAME}"

if [ "$SITE_PATH" != "sites/default" ]; then
  if [ ! -f ${DDEV_DOCROOT}/${SITE_PATH}/settings.ddev.php ]; then
    cp ${DDEV_DOCROOT}/sites/default/settings.ddev.php ${DDEV_DOCROOT}/${SITE_PATH}/settings.ddev.php
    sed -i "s/\['database'\] = \"db\"/\['database'\] = \"${DBNAME}\"/g" ${DDEV_DOCROOT}/${SITE_PATH}/settings.ddev.php
  fi
  ddev create-database ${DBNAME} || exit 1
fi


# Take care of redis settings if needed
if [ -f ${DDEV_DOCROOT}/sites/default/settings.ddev.redis.php ]; then
  cp -f ${DDEV_DOCROOT}/sites/default/settings.ddev.redis.php ${DDEV_DOCROOT}/${SITE_PATH}/settings.ddev.redis.php

  SETTINGS_FILE_NAME="${DDEV_DOCROOT}/${SITE_PATH}/settings.php"
  if grep "Include settings required for Redis cache" $SETTINGS_FILE_NAME; then
    echo "Settings file already includes settings.ddev.redis.php"
  else
    echo "Settings file name: ${SETTINGS_FILE_NAME}"
    grep -qF 'settings.ddev.redis.php' $SETTINGS_FILE_NAME || echo "
    // Include settings required for Redis cache.
    if ((file_exists(__DIR__ . '/settings.ddev.redis.php') && getenv('IS_DDEV_PROJECT') == 'true')) {
      include __DIR__ . '/settings.ddev.redis.php';
    }" >> $SETTINGS_FILE_NAME
  fi
fi

if [ -f "${DDEV_DOCROOT}/${SITE_PATH}/example.settings.local.php" ]; then
  cp "${DDEV_DOCROOT}/${SITE_PATH}/example.settings.local.php" "${DDEV_DOCROOT}/${SITE_PATH}/settings.local.php"
  echo "File 'example.settings.local.php' in site folder copied to 'settings.local.php'"
fi

if [ -f "${DDEV_DOCROOT}/${SITE_PATH}/example.local.drush.yml" ]; then
  cp "${DDEV_DOCROOT}/${SITE_PATH}/example.local.drush.yml" "${DDEV_DOCROOT}/${SITE_PATH}/local.drush.yml"
  sed -i -e "s|http://example.docker.localhost:8000|${DDEV_PRIMARY_URL}|g" "${DDEV_DOCROOT}/${SITE_PATH}/local.drush.yml"
  echo "File 'example.local.drush.yml' in site folder copied to 'local.drush.yml' and configured with DDEV primary URL"
fi

echo -e "\nDropping existing database (if any)"
ddev_drush sql:drop -y || exit 1

# Process files archive if provided (before site installation)
if [ -n "$FILES_ARCHIVE" ]; then
  echo -e "\nProcessing files archive..."

  # Get the target files directory from drush
  FILES_DIR=${DDEV_DOCROOT}/${SITE_PATH}/files
  if [ -z "$FILES_DIR" ]; then
    echo "Error: Could not determine files directory location"
    exit 1
  fi

  echo "Target files directory: ${FILES_DIR}"

  # Create temporary extraction directory
  TEMP_EXTRACT_DIR=$(mktemp -d)
  trap "rm -rf $TEMP_EXTRACT_DIR" EXIT

  # Detect file format and extract
  if [[ "$FILES_ARCHIVE" =~ \.tar\.gz$ ]] || [[ "$FILES_ARCHIVE" =~ \.tgz$ ]]; then
    echo "Detected tar.gz archive format"
    tar -xzf "$FILES_ARCHIVE" -C "$TEMP_EXTRACT_DIR" || {
      echo "Error: Failed to extract tar.gz archive"
      exit 1
    }
  elif [[ "$FILES_ARCHIVE" =~ \.zip$ ]]; then
    echo "Detected zip archive format"
    unzip -q "$FILES_ARCHIVE" -d "$TEMP_EXTRACT_DIR" || {
      echo "Error: Failed to extract zip archive"
      exit 1
    }
  else
    echo "Error: Unsupported archive format. Only .tar.gz, .tgz, and .zip are supported"
    exit 1
  fi

  # Determine source directory structure
  # Check if archive contains a single 'files' directory or multiple items
  ITEM_COUNT=$(ls -A "$TEMP_EXTRACT_DIR" | wc -l)

  if [ "$ITEM_COUNT" -eq 1 ] && [ -d "$TEMP_EXTRACT_DIR/files" ]; then
    # Archive contains only a 'files' directory
    SOURCE_DIR="$TEMP_EXTRACT_DIR/files"
    echo "Archive contains a 'files' directory"
  else
    # Archive contains multiple items or no 'files' directory
    SOURCE_DIR="$TEMP_EXTRACT_DIR"
    echo "Archive contains multiple items, will copy all contents"
  fi

  # Ensure target directory exists
  mkdir -p "${FILES_DIR}"

  # Copy files, overwriting existing ones
  echo "Copying files to ${FILES_DIR}..."
  cp -rf "$SOURCE_DIR"/* "${FILES_DIR}/" || {
    echo "Error: Failed to copy files"
    exit 1
  }

  # Set proper permissions
  chmod -R u+w "${FILES_DIR}"

  echo "Files archive extracted and merged successfully"
fi

# If a database file is given, import it to the site if not, install the site
run_hooks "pre_site_install"
if [ "$INSTALL_MODE" == "db" ]; then
  echo -e "\nLoading database from file $DB_FILE"
  run_hooks "pre_site_install_db"
  ddev import-db --file $DB_FILE --database ${DBNAME} || exit 1
  ddev_drush deploy
  run_hooks "post_site_install_db"
elif [ "$INSTALL_MODE" == "config" ]; then
  echo -e "\nInstalling site '${SITE}' using drupal profile '${DRUPAL_PROFILE}'"
  run_hooks "pre_site_install_config"

  ddev_drush site:install ${DRUPAL_PROFILE:+$DRUPAL_PROFILE }--existing-config -y --sites-subdir=${SITE_PATH#sites/} || exit 1
  ddev_drush cr
  ddev_drush cim -y
  ddev_drush cr
  run_hooks "post_site_install_config"
else
  echo "Error: Unknown installation mode '$INSTALL_MODE'."
  exit 1
fi

run_hooks "post_site_install"
ddev status
echo "Now you can login to your site:\n"
ddev_drush uli
